<!doctype html>
<html lang="en">

<head>
    <title>The Spoken World</title>
    <meta charset=utf-8 />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="" />
    <!-- Marker Clusters -->
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.Default.css">
    <link rel="stylesheet" href="libs/Leaflet.markercluster/MarkerCluster.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Lato|Oswald" rel="stylesheet">
    <!--font-family: 'Oswald', sans-serif;
    font-family: 'Lato', sans-serif;-->
    <!-- Sidebar V-2 -->
    <link rel="stylesheet" href="libs/sidebar-v2/leaflet-sidebar.css" />
    <!-- Google Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        
        h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 4.5em;
            color: white;
            text-align: center;
        }
        
        h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 1em;
            color: #d74840;
        }
        
        p {
            font-family: 'Lato', sans-serif;
            font-size: .9em;
        }
        
        html,
        body,
        #map {
            height: 100%;
            width: 100vw;
        }
        
        #sound {
            z-index: 1999;
            bottom: 12px;
            left: 61px;
            position: absolute;
        }
        
        audio {
            z-index: 1999;
            bottom: 13px;
            left: 61px;
            position: absolute;
        }
    </style>
</head>

<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="material-icons">toc</i></a></li>
                <li><a href="#search" role="tab"><i class="material-icons">search</i></a></li>
                <li><a href="#audio" role="tab"><i class="material-icons">hearing</i></a></li>
                <li><a href="#share" role="tab"><i class="material-icons">share</i></a></li>
                <!--                <li class="disabled"><a href="#messages" role="tab"><i class="material-icons">mail_outline</i></a></li>-->
            </ul>
            <ul role="tablist">
                <li><a href="#info" role="tab"><i class="material-icons">info</i></a></li>
                <!--                <li><a href="#settings" role="tab"><i class="material-icons">settings</i></a></li>-->
                <!--                <li><a href="https://github.com/mikus31/the-spoken-world" role="tab" target="_blank"><i class="material-icons">link</i></a></li>-->
            </ul>
        </div>
        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">The Spoken World<span class="sidebar-close"><i class="material-icons">chevron_left</i></span>
                </h1>
                <p>An interactive worldwide map of place-name pronunciations.</p>
                <p>To begin using the map, close this popup by clicking on the arrow above. On the map, you can zoom in, zoom out, and pan using your mouse (on desktop) or fingers (on mobile or tablet). Clicking on a numbered cluster marker also will zoom in to the map. </p>
                <p>To access the audio for a particular place, click on the red map markers and then on the play button.</p>
                <p>Read more about the project <a href='https://github.com/mikus31/the-spoken-world' target="_blank">on GitHub</a>.</p>
            </div>
            <div class="sidebar-pane" id="audio">
                <h1 class="sidebar-header">Audio History<span class="sidebar-close"><i class="material-icons">chevron_left</i></span></h1>
                <p>Audio controls?</p>
                <p>Last five?</p>
                <p>Most popular?</p>
            </div>
            <div class="sidebar-pane" id="search">
                <h1 class="sidebar-header">Search<span class="sidebar-close"><i class="material-icons">chevron_left</i></span></h1>
                <p>Embed <a href='https://github.com/stefanocudini/leaflet-search' target="_blank">leaflet-search?</a></p>
            </div>
            <div class="sidebar-pane" id="info">
                <h1 class="sidebar-header">More Information<span class="sidebar-close"><i class="material-icons">chevron_left</i></span></h1>
                <h2>Data Sources</h2>
                <p>Populated places point data from <a href='http://www.naturalearthdata.com/' target="_blank">Natural Earth</a>.</p>
                <p>Custom basemap created in <a href='https://www.mapbox.com/' target="_blank">Mapbox Studio</a>.</p>
                <p>Place-name pronunciations from <a href='https://forvo.com/' target="_blank">Forvo</a>.</p>
                <h2>Mapping Libraries</h2>
                <p><a href='https://leafletjs.com/' target="_blank">Leaflet JS</a></p>
                <p><a href='https://github.com/Leaflet/Leaflet.markercluster' target="_blank">Leaflet Marker Cluster</a></p>
                <p><a href='https://github.com/Turbo87/sidebar-v2' target="_blank">Leaflet Sidebar-v2</a></p>
                <h2>Design Elements</h2>
                <p>Fonts from <a href='https://fonts.google.com/' target="_blank">Google Fonts</a>.</p>
                <p>Icons from <a href='https://thenounproject.com/' target="_blank">The Noun Project</a> and <a href='https://material.io/' target="_blank">Material Design</a>.</p>
                <p>Colors by <a href='http://stevescott.com.au/' target="_blank">Steven Scott</a> via <a href='https://colorsupplyyy.com/app' target="_blank">ColorSupplyyy</a>, where I spent hours playing with their fun color picking tool!</p>
                <h2>Acknowledgments</h2>
                <p>Special thanks to <a href='https://stpao.org/' target="_blank">Louis Fitzmorris</a>, Rich Donohue, the New Maps Plus Slack channel, my cousin Asher for inspiring <a href='https://github.com/mikus31/the-spoken-world' target="_blank">the project</a>, and my supportive, honest-feedback-providing wife Sarah.</p>
                <h2>About</h2>
                <p>Master's Degree project by <a href='https://www.linkedin.com/in/michael-mcneil-8279ba51/' target="_blank">Michael McNeil</a> for <a href='https://newmapsplus.as.uky.edu/' target="_blank">New Maps Plus</a> at the <a href='http://www.uky.edu/UKHome/' target="_blank">University of Kentucky</a>.</p>
            </div>
            <div class="sidebar-pane" id="share">
                <h1 class="sidebar-header">Share This Map!<span class="sidebar-close"><i class="material-icons">chevron_left</i></span></h1>
                <p><a href="https://twitter.com/home?status=The%20Spoken%20World,%20an%20interactive%20map%20of%20place-name%20pronunciations%20(by%20%40mikusthetiger%20for%20%40newmapsplus%20%40universityofky)%20---%3E%20%20https%3A//mikus31.github.io/the-spoken-world/" target="_blank">Share on Twitter</a></p>
                <p><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//mikus31.github.io/the-spoken-world/" target="_blank">Share on Facebook</a></p>
                <p><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//mikus31.github.io/the-spoken-world/&title=The%20Spoken%20World&summary=An%20interactive%20map%20of%20place-name%20pronunciations.&source=" target="_blank">Share on LinkedIn</a></p>
            </div>
            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="material-icons">chevron_left</i></span></h1>
                <p>Light Mode / Dark Mode switch?</p>
                <p>Choose language?</p>
            </div>
        </div>
    </div>
    <div id="map" class="sidebar-map">
        <!--        <button id="sound">click for audio</button>-->
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.2.0/mapbox.js'></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="libs/sidebar-v2/leaflet-sidebar.js"></script>
    <script>
        // create map
        L.mapbox.accessToken = 'pk.eyJ1IjoibWlrdXMzMSIsImEiOiJjanVrNGgyaTIxcDNpM3lwaXB3dnowa2VpIn0.uNKvtTY9Is0M7xKSl_ukjQ';
        // add light mode and dark mode here
        var lightMode = L.mapbox.styleLayer('mapbox://styles/mikus31/cjajul8jxb6212rq7ly2wgenz')
            , darkMode = L.mapbox.styleLayer('mapbox://styles/mikus31/cjuvg0hhxc3011fpo0h58juwq');
        // initialize the map in lightMode
        var map = L.map('map', {
            layers: [lightMode]
        });
        // create text for basemap switcher box
        var baseMaps = {
            "Light Mode": lightMode
            , "Dark Mode": darkMode
        };
        // add the basemap switcher box to the map
        L.control.layers(baseMaps).addTo(map);
        // allow map to access user's location?
        /*map.locate({
            setView: true
            , maxZoom: 16
        });*/
        // create custom marker icon
        var audioIcon = L.icon({
            iconUrl: 'images/marker-red.png'
            , iconSize: [40, 40], // size of the icon 
            iconAnchor: [20, 20], // point of the icon which will correspond to marker's location 
            popupAnchor: [0, 0]
                // point from which the popup should open relative to the iconAnchor 
        });
        // load places geojson and call function to add data to map
        $.getJSON("data/places-newtable.geojson", function (data) {
            drawPlaces(data);
        });
        // add sidebar to map
        var sidebar = L.control.sidebar('sidebar').addTo(map);
        sidebar.open('home');
        // add function to close sidebar when user zooms in
        // map.setZoom in drawPlaces is causing this to fire when the page loads ... is there a way to delay this function until the user zooms in?
        /*map.on('zoom', function () { sidebar.close(); });*/
        function drawPlaces(data) {
            var places = L.geoJson(data);
            // set the zoom/center to the extent of the geojson
            map.fitBounds(places.getBounds());
            // and then zoom in a tad
            map.setZoom(map.getZoom() + .5);
            // set the max bounds to prevent user from scrolling beyond bounds?
            map.setMaxBounds(map.getBounds());
            // create new markerClusterGroup
            var markers = L.markerClusterGroup();
            // close the sidebar when cluster is clicked
            markers.on('clusterclick', function () {
                sidebar.close();
            });
            // loop through all the features
            data.features.forEach(function (feature) {
                // create a new Leaflet marker for each
                var coords = feature.geometry.coordinates
                    , marker = L.marker([coords[1], coords[0]], {
                        icon: audioIcon
                    });
                // create a tooltip for the markers ...
                var props = feature.properties;
                // console.log(props.nameascii);
                var placesPopup = props.nameascii;
                // ... and bind it to the markers
                marker.bindTooltip(placesPopup);
                // add the individual markers to the markerClusterGroup
                markers.addLayer(marker);
                /*d3.select('#sound').on('click', function () { placeName = placesPopup; // trying some things here ... // need to pass the clicked feature place name to forvo to retrieve the corresponding sound file ... // buttonClick(this); // placeName = 'Reykjavik'; url = 'https://apifree.forvo.com/key/f08a91897cb826f93096d8ea72e87c4e/format/json/action/word-pronunciations/word/' + placeName + '/language/en' getPath(url); });*/
                marker.feature = {
                    properties: {
                        placeName: props.nameascii
                    }
                }
                marker.on('click', function () {
                    // close the sidebar if still open
                    sidebar.close();
                    let placeName = this.feature.properties.placeName;
                    console.log(placeName)
                    let url = 'https://apifree.forvo.com/key/f08a91897cb826f93096d8ea72e87c4e/format/json/action/standard-pronunciation/word/' + placeName;
                    console.log(url)
                    getPath(url);
                });
            });
            // add the markerClusterGroup to the map
            map.addLayer(markers);
        }

        function getPath(path) {
            $.ajax({
                    url: path
                    , type: 'GET'
                    , dataType: 'jsonp'
                    , cors: true
                    , contentType: 'application/json'
                    , secure: true
                    , headers: {
                        'Access-Control-Allow-Origin': '*'
                    , }
                    , beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", "Basic " + btoa(""));
                    }
                    , success: function (data) {
                        let mp3Path = data.items[0].pathmp3;
                        let oggPath = data.items[0].pathogg;
                        d3.select('audio').remove();
                        d3.select('body').append('audio').attr('controls', '').append('source').attr('type', 'audio/mpeg').attr('src', mp3Path)
                        d3.select('audio').append('source').attr('type', 'audio/ogg').attr('src', oggPath)
                    }
                    , failure: function (data) {
                        console.log('uh oh, no audio file!')
                    }
                })
                // console.log(url);
        }
    </script>
</body>

</html>